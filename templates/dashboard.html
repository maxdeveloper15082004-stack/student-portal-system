{% extends 'base.html' %} {% block content %}
<style>
  * {
    box-sizing: border-box;
  }

  .dashboard-container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
  }

  .welcome-section {
    margin-bottom: 2rem;
    text-align: center;
  }

  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .dash-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    transition:
      transform 0.2s,
      box-shadow 0.2s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .dash-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
    border-color: var(--primary);
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .card-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text);
    margin-bottom: 0.5rem;
  }

  .card-input {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 1.2rem;
    padding: 0.75rem 1.5rem;
    width: 100%;
    border-radius: 0.5rem;
    font-weight: 600;
    text-align: center;
    outline: none;
    transition: border-color 0.2s;
    font-family: inherit;
  }

  .card-input:focus {
    border-color: var(--primary);
  }

  .card-input[readonly] {
    opacity: 0.7;
    cursor: default;
  }

  .action-btn {
    background: var(--primary);
    color: #ffffff;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    width: 100%;
    margin-top: auto;
    text-transform: uppercase;
    transition:
      background 0.2s,
      transform 0.2s;
  }

  .action-btn:hover {
    background: var(--primary-hover);
    transform: scale(1.02);
  }

  .profile-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .avatar {
    width: 64px;
    height: 64px;
    background: var(--primary);
    color: #ffffff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 800;
  }

  .span-2-card {
    grid-column: span 2;
  }

  .search-card {
    grid-column: 1 / -1;
    margin: 1rem auto;
    width: 100%;
    max-width: 800px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }
  th {
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    padding: 1rem;
    text-align: left;
  }
  td {
    padding: 1rem;
    border-bottom: 1px solid var(--border);
  }
  tr:last-child td {
    border-bottom: none;
  }
  tr:hover td {
    background: rgba(255, 255, 255, 0.03);
  }

  @media (max-width: 768px) {
    #user-greeting {
      font-size: 1.5rem !important;
    }
    .span-2-card,
    .search-card {
      grid-column: span 1;
      margin: 0;
      width: auto;
      max-width: none;
    }
  }

  select.card-input option {
    background: var(--bg);
    color: var(--text);
  }
</style>

<div class="dashboard-container">
  <div
    class="welcome-section"
    style="
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2rem;
    "
  >
    <div
      id="user-greeting"
      style="
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--text);
        text-transform: capitalize;
      "
    ></div>
  </div>

  <div id="loading" style="text-align: center; padding: 2rem">
    <div style="font-size: 1.2rem; color: var(--text-muted)">
      Loading dashboard data...
    </div>
  </div>

  <div id="content" style="display: none"></div>
</div>

<script>
  async function loadDashboard() {
    const res = await fetch("/api/dashboard/", {
      headers: {
        "Content-Type": "application/json",
      },
    });

    if (res.status === 403 || res.status === 401) {
      window.location.href = "/login/";
      return;
    }

    const data = await res.json();
    document.getElementById("loading").style.display = "none";
    const contentDiv = document.getElementById("content");
    contentDiv.style.display = "block";

    if (data.role === "admin") {
      const admin = data.profile;
      document.getElementById("user-greeting").textContent =
        `Hello, ${admin.username}`;

      let html = `
            <div class="dash-card">
                <div class="card-header">Profile Details</div>
                <div class="profile-info">
                    <div class="avatar">${admin.username[0].toUpperCase()}</div>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1rem;">${
                          admin.username
                        }</div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">${
                          admin.email
                        }</div>
                        <div style="color: var(--text); font-size: 0.8rem; margin-top: 0.25rem; font-weight: 600; text-transform: uppercase; background: var(--primary); padding: 2px 8px; border-radius: 10px; display: inline-block;">${
                          data.role
                        }</div>
                    </div>
                </div>
            </div>

            <div class="dash-card">
                <div class="card-header">Class</div>
                <input type="text" class="card-input" value="${
                  admin.std_class || "N/A"
                }" readonly>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Managed Class</div>
            </div>

            <div class="dash-card">
                <div class="card-header">Section</div>
                <input type="text" class="card-input" value="${
                  admin.section || "N/A"
                }" readonly>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Assigned Section</div>
            </div>

            <div class="dash-card">
                <div class="card-header">Total Students</div>
                <div class="card-value" style="text-align: center;">${
                  data.data.length
                }</div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Enrolled</div>
            </div>

            <div class="dash-card">
                 <div class="card-header">Current Semester</div>
                 <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center;">
                    <input type="number" id="admin-current-semester" class="card-input" style="width: 80px;" value="${
                      admin.current_semester || 1
                    }" min="1" max="8">
                    <button class="action-btn" style="width: auto; padding: 0.5rem 1rem; margin: 0; font-size: 0.8rem;" onclick="updateSemester()">Update</button>
                 </div>
                 <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Active Semester</div>
            </div>

            <div class="dash-card search-card">
                <div class="card-header">Search Student</div>
                <input type="text" id="searchInput" class="card-input" placeholder="Search by Register Number..." style="margin-bottom: 1rem;" oninput="filterStudents(this.value)">
                <div style="width: 100%; display: flex; justify-content: center;">
                    <button class="action-btn" onclick="searchStudentBtn()" style="max-width: 200px;">Search</button>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Start typing to search</div>
            </div>

            <div class="dash-card" style="grid-column: 1 / -1; margin-top: 1rem;">
                <div class="card-header">All Students</div>
                <div style="overflow-x: auto;">
                    <table id="students-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Reg. No</th>
                                <th>CGPA</th>
                                <th>Attendance</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>`;

      data.data.forEach((student, index) => {
        html += `<tr class="student-row">
                            <td>${index + 1}</td>
                            <td class="student-name" style="font-weight: 600;">${
                              student.username
                            }</td>
                            <td>${student.email}</td>
                            <td class="student-reg">${
                              student.register_number || "-"
                            }</td>
                            <td>${student.cgpa || "-"}</td>
                            <td>${student.attendance || "-"}%</td>
                            <td>
                                <button onclick="forceLogoutStudent(${student.id}, '${student.username}', this)" style="background: #ef4444; color: white; border: none; padding: 0.4rem 1rem; border-radius: 0.35rem; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: background 0.2s; font-family: inherit;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">Logout</button>
                            </td>
                         </tr>`;
      });

      html += `</tbody></table></div></div></div>
       
       <div id="search-result-container" style="width: 100%; margin-top: 2rem;"></div>

       <div style="margin-top: 4rem; text-align: center;">
            <div style="cursor: pointer; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; transition: all 0.2s; padding: 1rem 4rem; border-radius: 0.5rem; display: inline-block;" onclick="logout()" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                <span style="color: #ff6b6b; font-weight: 700; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.05em;">Logout</span>
            </div>
        </div>
      `;
      contentDiv.innerHTML = `<div class="dashboard-grid">${html}`;

      window.dashboardData = data;
    } else {
      const student = data.data;
      document.getElementById("user-greeting").textContent =
        `Hello, ${student.username}`;
      contentDiv.innerHTML = getStudentDashboardHTML(student, data.role);
    }
  }

  function getStudentDashboardHTML(student, role, isEmbedded = false) {
    let backBtn = "";
    let logoutBtn = "";

    if (role === "student") {
      logoutBtn = `
            <div style="margin-top: 4rem; text-align: center;">
                <div style="cursor: pointer; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; transition: all 0.2s; padding: 1rem 4rem; border-radius: 0.5rem; display: inline-block;" onclick="logout()" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                    <span style="color: #ef4444; font-weight: 700; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.05em;">Logout</span>
                </div>
            </div>`;
    }

    if (role === "admin" && !isEmbedded) {
      backBtn = `<div style="margin-bottom: 2rem;">
                        <button onclick="loadDashboard()" class="action-btn" style="width: auto; padding: 0.5rem 2rem;">‚Üê Back to Dashboard</button>
                     </div>`;
    }

    const isEditable = role === "admin" && isEmbedded;
    const readOnlyAttr = isEditable ? "" : "readonly";
    const cursorStyle = isEditable ? "text" : "default";

    let saveBtn = "";
    if (isEditable) {
      saveBtn = `
            <div style="grid-column: 1 / -1; text-align: center; margin-top: 2rem;">
                <button class="action-btn" style="width: auto; padding: 1rem 4rem;" onclick="saveStudentDetails(${student.id})">Save Changes</button>
            </div>
        `;
    }

    let sectionTitle = isEmbedded
      ? `<h2 style="margin: 2rem 0 1rem; border-top: 1px solid var(--border); padding-top: 2rem; color: white;">Student Details: ${student.username}</h2>`
      : "";

    return `
        ${backBtn}
        ${sectionTitle}
        <div class="dashboard-grid">
            <div class="dash-card">
                <div class="card-header">Profile Details</div>
                <div class="profile-info">
                    <div class="avatar">${student.username[0].toUpperCase()}</div>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1rem;">${
                          student.username
                        }</div>
                        <div style="color: var(--text-muted); font-size: 0.9rem;">${
                          student.email
                        }</div>
                        <div style="color: var(--text); font-size: 0.8rem; margin-top: 0.25rem; font-weight: 600; text-transform: uppercase; background: var(--primary); padding: 2px 8px; border-radius: 10px; display: inline-block;">student</div>
                    </div>
                </div>
            </div>

            <div class="dash-card">
                <div class="card-header">Register Number</div>
                <input type="text" id="edit-regnum-${
                  student.id
                }" class="card-input" placeholder="000000" value="${
                  student.register_number || ""
                }" ${readOnlyAttr} style="cursor: ${cursorStyle};">
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Official University ID</div>
            </div>

            <div class="dash-card">
                <div class="card-header">Class</div>
                <select id="edit-class-${
                  student.id
                }" class="card-input" ${readOnlyAttr} style="cursor: ${cursorStyle}; appearance: none;">
                    <option value="First Year" ${
                      student.std_class === "First Year" ? "selected" : ""
                    }>First Year</option>
                    <option value="Second Year" ${
                      student.std_class === "Second Year" ? "selected" : ""
                    }>Second Year</option>
                    <option value="Third Year" ${
                      student.std_class === "Third Year" ? "selected" : ""
                    }>Third Year</option>
                    <option value="Final Year" ${
                      student.std_class === "Final Year" ? "selected" : ""
                    }>Final Year</option>
                </select>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Year</div>
            </div>

            <div class="dash-card">
                <div class="card-header">Section</div>
                <input type="text" id="edit-section-${
                  student.id
                }" class="card-input" value="${
                  student.section || ""
                }" ${readOnlyAttr} style="cursor: ${cursorStyle};">
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Section</div>
            </div>

            <div class="dash-card">
                <div class="card-header">Advisor Name</div>
                    <input type="text" class="card-input" value="${
                      student.advisor_name || "N/A"
                    }" readonly>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Faculty Advisor (Auto-assigned)</div>
            </div>

            <div class="dash-card">
                <div class="card-header">CGPA Score</div>
                <input type="number" step="0.01" max="10" id="edit-cgpa-${
                  student.id
                }" class="card-input" placeholder="0.00" value="${
                  student.cgpa || ""
                }" ${readOnlyAttr} style="cursor: ${cursorStyle};">
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Cumulative Grade Point Average</div>
            </div>

            <div class="dash-card">
                <div class="card-header">Attendance</div>
                <input type="number" step="0.1" max="100" id="edit-attendance-${
                  student.id
                }" class="card-input" placeholder="0.0" value="${
                  student.attendance || ""
                }" ${readOnlyAttr} style="cursor: ${cursorStyle};">
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Percentage (%)</div>
            </div>
            
            <div class="dash-card">
                <div class="card-header">Current Semester</div>
                <div class="card-value" style="text-align: center;">${
                  student.current_semester || 1
                }</div>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Computer Science & Engineering</div>
            </div>

                <div class="dash-card">
                <div class="card-header">Academic Status</div>
                    <div class="card-value" style="color: #4ade80; text-align: center;">Active</div>
                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center;">Good Standing</div>
            </div>

            ${saveBtn}

        </div>
        ${logoutBtn}
      `;
  }

  function searchStudentBtn() {
    const input = document.getElementById("searchInput");
    if (!input) return;
    const regNo = input.value.toLowerCase().trim();
    if (!regNo) return;

    if (window.dashboardData && window.dashboardData.data) {
      const student = window.dashboardData.data.find(
        (s) => s.register_number && s.register_number.toLowerCase() === regNo,
      );
      const resultContainer = document.getElementById(
        "search-result-container",
      );

      if (student) {
        resultContainer.innerHTML = getStudentDashboardHTML(
          student,
          "admin",
          true,
        );
        resultContainer.style.display = "block";
        resultContainer.scrollIntoView({ behavior: "smooth" });
      } else {
        alert("Student not found with Register Number: " + input.value);
        resultContainer.style.display = "none";
      }
    }
  }

  function filterStudents(query) {
    const rows = document.querySelectorAll(".student-row");
    const searchTerm = query.toLowerCase();

    rows.forEach((row) => {
      const regNo = row.querySelector(".student-reg").textContent.toLowerCase();
      if (regNo.includes(searchTerm)) {
        row.style.display = "";

        let actionCell = row.querySelector(".action-cell");
        if (!actionCell) {
          row.style.cursor = "pointer";
          row.onclick = function () {
            const studentId = row.cells[0].textContent;
            const student = window.dashboardData.data.find(
              (s) => s.id == studentId,
            );
            if (student) {
              const resultContainer = document.getElementById(
                "search-result-container",
              );
              resultContainer.innerHTML = getStudentDashboardHTML(
                student,
                "admin",
                true,
              );
              resultContainer.style.display = "block";
              resultContainer.scrollIntoView({ behavior: "smooth" });
            }
          };
          row.title = "Click to view details";
        }
      } else {
        row.style.display = "none";
      }
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function saveStudentDetails(studentId) {
    const regNum = document.getElementById(`edit-regnum-${studentId}`).value;
    const stdClass = document.getElementById(`edit-class-${studentId}`).value;
    const section = document.getElementById(`edit-section-${studentId}`).value;
    const cgpa = document.getElementById(`edit-cgpa-${studentId}`).value;
    const attendance = document.getElementById(
      `edit-attendance-${studentId}`,
    ).value;

    if (!cgpa || !attendance) {
      alert(
        "Notification: Please ensure both CGPA and Attendance are entered.",
      );
      return;
    }

    if (parseFloat(cgpa) > 10) {
      alert("Notification: CGPA cannot exceed 10.");
      return;
    }

    if (parseFloat(attendance) > 100) {
      alert("Notification: Attendance cannot exceed 100.");
      return;
    }

    const updatedData = {
      register_number: regNum,
      std_class: stdClass,
      section: section,
      cgpa: cgpa,
      attendance: attendance,
    };

    try {
      const res = await fetch(`/api/student/${studentId}/update/`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify(updatedData),
      });

      if (res.ok) {
        const data = await res.json();
        alert("Student details updated successfully!");

        const index = window.dashboardData.data.findIndex(
          (s) => s.id === studentId,
        );
        if (index !== -1) {
          window.dashboardData.data[index] = {
            ...window.dashboardData.data[index],
            ...data,
          };
        }

        const resultContainer = document.getElementById(
          "search-result-container",
        );
        resultContainer.innerHTML = getStudentDashboardHTML(
          window.dashboardData.data[index],
          "admin",
          true,
        );
      } else {
        const err = await res.json();
        alert("Failed to update: " + JSON.stringify(err));
      }
    } catch (error) {
      alert("An error occurred while updating.");
    }
  }

  async function updateSemester() {
    const input = document.getElementById("admin-current-semester");
    const semester = input.value;
    if (!semester) return;

    try {
      const res = await fetch("/api/admin/update/", {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ current_semester: semester }),
      });

      if (res.ok) {
        alert(
          "Current Semester updated successfully! This will reflect in student dashboards.",
        );
        loadDashboard();
      } else {
        const err = await res.json();
        alert("Failed to update: " + JSON.stringify(err));
      }
    } catch (error) {
      alert("An error occurred.");
    }
  }

  async function forceLogoutStudent(studentId, username, btn) {
    if (
      !confirm(
        `Are you sure you want to logout and remove "${username}" from the site?`,
      )
    ) {
      return;
    }

    try {
      const res = await fetch(`/api/student/${studentId}/force-logout/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
      });

      if (res.ok) {
        const data = await res.json();

        // Remove student from local data
        if (window.dashboardData && window.dashboardData.data) {
          window.dashboardData.data = window.dashboardData.data.filter(
            (s) => s.id !== studentId,
          );
        }

        // Remove the table row
        const row = btn.closest("tr");
        if (row) row.remove();

        // Re-number remaining rows
        const rows = document.querySelectorAll(".student-row");
        rows.forEach((r, i) => {
          r.cells[0].textContent = i + 1;
        });

        // Update total students count
        const countEl = document.querySelector(
          ".card-value[style*='text-align: center']",
        );
        if (countEl && window.dashboardData) {
          countEl.textContent = window.dashboardData.data.length;
        }

        alert(data.message || `${username} has been removed.`);
      } else {
        const err = await res.json();
        alert("Failed: " + (err.error || JSON.stringify(err)));
      }
    } catch (error) {
      alert("An error occurred while removing the student.");
    }
  }

  loadDashboard();
</script>
{% endblock %}
